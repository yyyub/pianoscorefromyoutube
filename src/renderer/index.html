<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; media-src 'self' file:;">
  <title>YouTube to Piano Sheet Music</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/rhythm-game.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>🎹 YouTube to Piano Sheet Music</h1>
      <p class="subtitle">AI로 YouTube 영상을 피아노 악보로 변환</p>
    </header>

    <main>
      <div class="input-section">
        <div class="input-group">
          <label for="youtube-url">YouTube URL</label>
          <input
            type="text"
            id="youtube-url"
            placeholder="https://www.youtube.com/watch?v=..."
            autocomplete="off"
          >
          <span class="error-message" id="url-error"></span>
        </div>

        <div class="advisor-card">
          <div class="advisor-header">
            <h3>변환 가이드</h3>
            <p>곡 유형과 목표를 선택하면 권장 설정을 자동으로 맞춥니다.</p>
          </div>
          <div class="advisor-grid">
            <label class="advisor-field">
              <span>입력 곡 유형</span>
              <select id="source-type">
                <option value="piano-cover" selected>피아노 커버</option>
                <option value="original">원곡(보컬/밴드)</option>
                <option value="unknown">잘 모르겠음</option>
              </select>
            </label>
            <label class="advisor-field">
              <span>변환 목표</span>
              <select id="target-priority">
                <option value="accuracy" selected>원곡 유사도 우선</option>
                <option value="balanced">균형(정확도/난이도)</option>
                <option value="speed">빠른 초안 우선</option>
              </select>
            </label>
          </div>
          <div class="issue-row">
            <label class="option-row">
              <input type="checkbox" id="issue-offbeat">
              엇박/리듬 깨짐이 심함
            </label>
            <label class="option-row">
              <input type="checkbox" id="issue-wrong-notes">
              이상한 음(잡음성 노트)이 많음
            </label>
          </div>
          <div class="advisor-actions">
            <button id="apply-recommended-btn" class="btn btn-secondary" type="button">권장 설정 적용</button>
            <div id="setting-summary" class="setting-summary"></div>
          </div>
          <div id="recommendation-text" class="recommendation-text"></div>
        </div>

        <div class="button-group">
          <button id="start-btn" class="btn btn-primary">
            변환 시작
          </button>
          <button id="cancel-btn" class="btn btn-secondary" disabled>
            취소
          </button>
        </div>

        <div class="option-group">
          <label class="option-row">
            <input type="checkbox" id="use-separation" checked>
            음원 분리 (Demucs AI) - 보컬/반주 분리로 품질 향상
          </label>
          <label class="option-row">
            난이도:
            <select id="quality-mode">
              <option value="beginner">초급 (쉬운 악보)</option>
              <option value="intermediate" selected>중급 (적당한 난이도)</option>
              <option value="advanced">고급 (원곡에 가까움)</option>
            </select>
          </label>
        </div>
      </div>

      <div class="history-section" id="history-section">
        <div class="history-header">
          <h3>변환 기록</h3>
        </div>
        <div class="history-list" id="history-list">
          <div class="history-empty">변환 기록이 없습니다.</div>
        </div>
      </div>

      <div class="progress-section" id="progress-section">
        <div class="progress-steps">
          <div class="progress-step" data-step="1">
            <div class="step-icon">1</div>
            <div class="step-label">다운로드</div>
            <div class="step-status">대기 중</div>
          </div>
          <div class="progress-step" data-step="2">
            <div class="step-icon">2</div>
            <div class="step-label">변환</div>
            <div class="step-status">대기 중</div>
          </div>
          <div class="progress-step" data-step="3">
            <div class="step-icon">3</div>
            <div class="step-label">전사</div>
            <div class="step-status">대기 중</div>
          </div>
          <div class="progress-step" data-step="4">
            <div class="step-icon">4</div>
            <div class="step-label">MIDI 저장</div>
            <div class="step-status">대기 중</div>
          </div>
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-info">
          <div class="progress-text" id="progress-text">준비 완료</div>
          <div class="eta-text" id="eta-text"></div>
        </div>
      </div>

      <div class="log-section">
        <div class="log-header">
          <h3>처리 로그</h3>
          <button id="clear-log-btn" class="btn-icon">지우기</button>
        </div>
        <div class="log-container" id="log-container">
          <div class="log-message log-info">
            YouTube URL을 입력하고 '변환 시작' 버튼을 클릭하세요.
          </div>
        </div>
      </div>

      <div class="result-section" id="result-section">
        <div class="result-card">
          <h3>✅ 변환 완료!</h3>
          <p id="result-message">MIDI 파일이 생성되었습니다.</p>
          <div class="button-group">
            <button id="open-pdf-btn" class="btn btn-primary">MIDI 열기</button>
            <button id="open-folder-btn" class="btn btn-secondary">폴더 열기</button>
          </div>
          <div class="button-group" style="margin-top:10px">
            <button id="rhythm-game-result-btn" class="btn btn-primary" style="background:linear-gradient(135deg,#4D96FF,#6BCB77)">리듬게임</button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>
        <a href="#" id="rhythm-game-btn" style="font-weight:600;">리듬게임</a> |
        FFmpeg 설치 필요 |
        <a href="#" id="help-link">도움말</a> |
        <a href="#" id="about-link">정보</a>
      </p>
    </footer>
  </div>

  <!-- Rhythm Game Overlay -->
  <div id="rhythm-game-overlay" class="rhythm-game-overlay">
    <!-- Song Selection View -->
    <div id="game-song-select" class="game-view">
      <div class="game-header">
        <h2>Rhythm Game</h2>
        <button id="game-close-btn">✕</button>
      </div>

      <!-- Mode Tabs -->
      <div class="mode-tabs">
        <button id="mode-tab-piano" class="mode-tab active">Piano Mode</button>
        <button id="mode-tab-vocal" class="mode-tab">Vocal Mode</button>
      </div>

      <div class="game-settings">
        <div class="setting-item">
          <label>노트 속도:</label>
          <input type="range" id="note-speed" min="200" max="800" value="400">
          <span class="setting-value" id="speed-value">400</span>
        </div>
        <div class="setting-item">
          <label>싱크 보정:</label>
          <input type="range" id="audio-offset" min="-200" max="200" value="0" step="10">
          <span class="setting-value" id="offset-value">0ms</span>
        </div>
        <div class="setting-item">
          <label>판정:</label>
          <select id="judge-difficulty">
            <option value="easy">Easy (넓음)</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard (좁음)</option>
            <option value="very-hard">Very Hard</option>
          </select>
        </div>
      </div>

      <!-- Piano Mode Panel -->
      <div id="piano-song-panel" class="song-panel">
        <div style="width:100%;max-width:700px;margin-bottom:12px;">
          <button id="game-import-btn" class="game-btn game-btn-secondary" style="width:100%;">외부 MIDI 파일 불러오기</button>
        </div>
        <div id="song-list" class="song-list"></div>
      </div>

      <!-- Vocal Mode Panel -->
      <div id="vocal-song-panel" class="song-panel" style="display:none;">
        <div class="vocal-url-section">
          <div class="vocal-url-row">
            <input type="text" id="vocal-url-input" class="vocal-url-input" placeholder="YouTube URL 입력..." autocomplete="off">
            <button id="vocal-analyze-btn" class="game-btn game-btn-primary vocal-analyze-btn">분석 시작</button>
          </div>
          <div id="vocal-progress" class="vocal-progress" style="display:none;">
            <div class="vocal-progress-bar-bg">
              <div id="vocal-progress-bar" class="vocal-progress-bar"></div>
            </div>
            <div id="vocal-progress-text" class="vocal-progress-text">준비 중...</div>
          </div>
        </div>
        <div class="vocal-list-header">이전에 분석한 곡</div>
        <div id="vocal-song-list" class="song-list"></div>
      </div>
    </div>

    <!-- Game Playing View -->
    <div id="game-playing" class="game-view">
      <div id="game-play-area" class="game-play-area">
        <canvas id="game-canvas"></canvas>
        <div id="game-hud" class="game-hud">
          <div class="hud-score" id="hud-score">0</div>
          <div class="hud-combo" id="hud-combo"></div>
          <div class="hud-judgment" id="hud-judgment"></div>
        </div>
        <div id="game-pause-overlay" class="game-pause-overlay">
          <h2>PAUSED</h2>
          <button id="game-resume-btn" class="game-btn game-btn-primary">Resume</button>
          <button id="game-quit-btn" class="game-btn game-btn-secondary">Quit</button>
        </div>
      </div>
      <video id="game-bg-video" class="game-bg-video" muted playsinline></video>
    </div>

    <!-- Results View -->
    <div id="game-results" class="game-view">
      <div class="results-card">
        <h2>Results</h2>
        <div id="results-stats"></div>
        <div class="results-buttons">
          <button id="results-retry-btn" class="game-btn game-btn-primary">Retry</button>
          <button id="results-back-btn" class="game-btn game-btn-secondary">Back</button>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts/app.js"></script>
  <script src="scripts/ui-controller.js"></script>
  <script src="scripts/progress-handler.js"></script>
  <script src="scripts/rhythm-game.js"></script>
  <script src="scripts/rhythm-game-ui.js"></script>
</body>
</html>
